<!doctype html>
<html lang="no">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>Moro med Mord — Online</title>
  <style>
    html, body { height: 100%; margin: 0; }
    body { background: #0b0f19; color: #fff; font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, "Helvetica Neue", Arial, "Noto Sans", "Apple Color Emoji", "Segoe UI Emoji"; }
    canvas { display: block; width: 100vw; height: 100vh; }
    canvas:focus { outline: none; }
  </style>
  <!-- Firebase SDK (for multi-device single-killer rounds). Keep these exactly in this order. -->
  <script defer src="https://www.gstatic.com/firebasejs/10.11.1/firebase-app-compat.js"></script>
  <script defer src="https://www.gstatic.com/firebasejs/10.11.1/firebase-firestore-compat.js"></script>
</head>
<body>
<canvas id="c" tabindex="0" aria-label="Moro med Mord" role="application"></canvas>
<script>
// Start only after window 'load' so Firebase defer scripts are ready
window.addEventListener('load', function(){
(function(){
  "use strict";

  // ——————————————————————————————————————————————
  // Config
  // ——————————————————————————————————————————————
  const COUNTDOWN_SECONDS = 3;   // 3 → 2 → 1 before reveal
  const ROUND_SECONDS = 120;     // killer's time window
  const WEAPONS = [
    "en hatt","en håndpistol","en katt","en paraply","en skje","en gummistøvel","en baguette","en fisk","en kaktus","en laserpeker","en badeand","en pizzaskjærer","en bok","en sykkelpumpe","et bananskall","en tomat","en lommelykt","en tulipan","en hårføner","en vannballong"
  ];

  // Toggle Firebase usage. Must be true + valid FIREBASE_CONFIG for online lobby.
  let USE_FIREBASE = true;

  // Paste your Firebase config here (complete object from console)
  const FIREBASE_CONFIG = {
    apiKey: "AIzaSyAjWKqzsZkaCOe7iheahP-3oet2E5XIKVM",
    authDomain: "m-med-m.firebaseapp.com",
    projectId: "m-med-m",
    appId: "1:269443451664:web:d7322bc7bec2b81e0c3395",            // recommended
    messagingSenderId: "PASTE_SENDER"  // recommended
  };

  // ——————————————————————————————————————————————
  // Canvas setup (HiDPI)
  // ——————————————————————————————————————————————
  const canvas = document.getElementById("c");
  const ctx = canvas.getContext("2d");
  let DPR = Math.max(1, Math.min(3, window.devicePixelRatio || 1));
  let W = 0, H = 0, CX = 0, CY = 0;
  function resize(){
    DPR = Math.max(1, Math.min(3, window.devicePixelRatio || 1));
    const w = window.innerWidth, h = window.innerHeight;
    canvas.width = Math.floor(w * DPR);
    canvas.height = Math.floor(h * DPR);
    canvas.style.width = w + "px";
    canvas.style.height = h + "px";
    ctx.setTransform(DPR, 0, 0, DPR, 0, 0);
    W = w; H = h; CX = W/2; CY = H/2;
  }
  window.addEventListener("resize", resize, { passive: true });
  resize();

  // ——————————————————————————————————————————————
  // Utilities
  // ——————————————————————————————————————————————
  const lerp = (a,b,t)=>a+(b-a)*t;
  const clamp = (v, lo, hi)=>Math.max(lo, Math.min(hi, v));
  const easeOutCubic = t => 1 - Math.pow(1-t, 3);
  const pick = arr => arr[Math.floor(Math.random()*arr.length)];
  const uid = () => Math.random().toString(36).slice(2) + Math.random().toString(36).slice(2);
  const qp = new URLSearchParams(location.search);

  // Persist local identity
  let local = {
    name: localStorage.getItem("mmm_name") || "",
    room: localStorage.getItem("mmm_room") || "",
    playerId: localStorage.getItem("mmm_pid") || uid(),
  };
  localStorage.setItem("mmm_pid", local.playerId);

  // ——————————————————————————————————————————————
  // Audio (killer-only beep at timeout)
  // ——————————————————————————————————————————————
  let audioCtx = null, audioEnabled = false; let TEST_MODE = false; let _test_beepCount = 0;
  function initAudio(){
    try{ if(!audioCtx){ audioCtx = new (window.AudioContext||window.webkitAudioContext)(); }
      if(audioCtx.state==='suspended'){ audioCtx.resume(); }
      audioEnabled = true; } catch(e){ audioEnabled = false; }
  }
  function playBeep(){
    if(TEST_MODE){ _test_beepCount++; return; }
    if(!audioEnabled || !audioCtx){ showToast("Lyd av (sing1 jam1). Trykk en gang."); return; }
    const now = audioCtx.currentTime + 0.02;
    const pattern = [ {f:440,d:0.18}, {f:659.25,d:0.18}, {f:880,d:0.28} ];
    let t = now;
    for(const n of pattern){
      const o = audioCtx.createOscillator(); const g = audioCtx.createGain();
      o.type='sine'; o.frequency.value=n.f; g.gain.setValueAtTime(0,t);
      g.gain.linearRampToValueAtTime(0.25,t+0.02); g.gain.exponentialRampToValueAtTime(0.0001,t+n.d);
      o.connect(g).connect(audioCtx.destination); o.start(t); o.stop(t+n.d+0.02); t += n.d + 0.03;
    }
  }

  // ——————————————————————————————————————————————
  // Game state
  // ——————————————————————————————————————————————
  const State = { Join:"join", Lobby:"lobby", Countdown:"countdown", Result:"result", RoundTimer:"roundtimer" };
  let state = State.Join;
  let countdownStart = 0;         // ms (server-aligned when online)
  let result = null;              // { type:"Kill"|"Flee", weapon?:string }
  let isKiller = false;
  let timerStartAt = null;        // ms when 120s begins (revealAt + 3s)

  // Firebase refs
  let fb = { app:null, db:null, roomRef:null, unsubRoom:null, unsubPlayers:null, backendReady:false };
  let room = null;       // room doc
  let players = [];      // array of player docs
  let heartbeatTimer = null;

  // ——————————————————————————————————————————————
  // Firebase init (robust + network fallbacks)
  // ——————————————————————————————————————————————
  function firebaseAvailable(){
    const cfgOK = FIREBASE_CONFIG && FIREBASE_CONFIG.projectId && !/PASTE_/.test(FIREBASE_CONFIG.projectId);
    return USE_FIREBASE && typeof window.firebase !== 'undefined' && cfgOK;
  }
  async function fbInitIfNeeded(){
    if(!firebaseAvailable()) return false;
    if(!fb.app){
      try{
        fb.app = firebase.initializeApp(FIREBASE_CONFIG);
        fb.db = firebase.firestore();
        // Debug level via ?debug=1
        firebase.firestore.setLogLevel(qp.get('debug')==='1' ? 'debug' : 'error');
        // Transport fixes for 400 WebChannel (corporate proxies, ad-blockers, third‑party cookie issues)
        const settings = { experimentalAutoDetectLongPolling: true };
        const transport = qp.get('transport');
        if(transport === 'longpoll') settings.experimentalForceLongPolling = true; // hard force
        if(transport === 'fetchstreams') settings.useFetchStreams = true;          // modern streaming
        if(transport === 'webchannel') { settings.experimentalAutoDetectLongPolling = false; }
        fb.db.settings(settings);
        fb.backendReady = true;
      } catch(e){ console.error('Firebase init failed', e); fb.backendReady=false; return false; }
    }
    return true;
  }

  // ——————————————————————————————————————————————
  // Join / presence / room subscriptions
  // ——————————————————————————————————————————————
  async function joinRoom(name, code){
    local.name = (name||'').trim(); local.room = (code||'').trim().toUpperCase();
    localStorage.setItem('mmm_name', local.name); localStorage.setItem('mmm_room', local.room);

    const ok = await fbInitIfNeeded();
    if(!ok){ showToast("Backend ikke klar – sjekk Firebase config"); state = State.Join; return; }

    fb.roomRef = fb.db.collection('rooms').doc(local.room);
    // Ensure room exists
    await fb.roomRef.set({ createdAt: firebase.firestore.FieldValue.serverTimestamp(), round:{ status:'idle', id:0 } }, { merge:true }).catch(e=>{
      showToast('Kunne ikke lage rom (sjekk regler/API‑key)'); console.error(e);
    });

    // Create/update player doc
    await fb.roomRef.collection('players').doc(local.playerId).set({ name: local.name, joinedAt: firebase.firestore.FieldValue.serverTimestamp(), lastSeen: firebase.firestore.FieldValue.serverTimestamp() }, { merge:true }).catch(e=>{
      showToast('Kunne ikke registrere spiller'); console.error(e);
    });

    // subscribe room doc
    fb.unsubRoom && fb.unsubRoom();
    fb.unsubRoom = fb.roomRef.onSnapshot(snap=>{
      room = snap.data() || null;
      if(room && room.round && room.round.status==='active'){
        const revealAt = room.round.revealAt ? room.round.revealAt.toMillis() : Date.now();
        countdownStart = revealAt; timerStartAt = revealAt + COUNTDOWN_SECONDS*1000;
        isKiller = room.round.killerId === local.playerId;
        result = { type: isKiller ? 'Kill' : 'Flee', weapon: isKiller ? room.round.weapon : undefined };
        state = State.Countdown;
      } else {
        // back to lobby
        result = null; isKiller=false; timerStartAt=null; if(state!==State.Join) state = State.Lobby;
      }
    }, err=>{
      showToast('Room subscription feilet'); console.error(err);
    });

    // subscribe players collection
    fb.unsubPlayers && fb.unsubPlayers();
    fb.unsubPlayers = fb.roomRef.collection('players').onSnapshot(snap=>{
      players = snap.docs.map(d=>({ id:d.id, ...d.data() }));
    }, err=>{ console.error('Players sub feilet', err); });

    // heartbeat
    clearInterval(heartbeatTimer);
    heartbeatTimer = setInterval(async ()=>{
      try{ await fb.roomRef.collection('players').doc(local.playerId).set({ lastSeen: firebase.firestore.FieldValue.serverTimestamp(), name: local.name }, { merge:true }); }catch(e){ /* ignore */ }
    }, 8000);

    state = State.Lobby;
  }

  async function startSharedRound(){
    // Safety: auto-join if SDK was slow
    if(!fb.roomRef){ if(!local.name || !local.room){ showToast('Bli med i et rom først'); state = State.Join; return; } await joinRoom(local.name, local.room); if(!fb.roomRef){ return; } }
    const ok = await fbInitIfNeeded(); if(!ok){ showToast('Backend ikke klar'); return; }

    // Enforce min players warning (still allows start)
    const now = Date.now();
    let actives = players.filter(p=> p.lastSeen && (now - p.lastSeen.toMillis()) < 20000);
    if(actives.length < 2){ showToast('Få spillere – invite flere (hoi1 ci2 zeoi3 hou2)'); }

    try{
      await fb.db.runTransaction(async tx => {
        const rsnap = await tx.get(fb.roomRef); const r = rsnap.data() || { round:{ status:'idle', id:0 } };
        if(r.round && r.round.status==='active') return; // someone else started
        const psnap = await fb.roomRef.collection('players').get();
        const now2 = Date.now();
        actives = psnap.docs.map(d=>({ id:d.id, ...d.data() })).filter(p=> p.lastSeen && (now2 - p.lastSeen.toMillis()) < 20000);
        if(actives.length === 0) throw new Error('No active players');
        const killer = pick(actives); const weapon = pick(WEAPONS);
        tx.set(fb.roomRef, { round:{ id:(r.round?.id||0)+1, status:'active', killerId:killer.id, weapon, revealAt: firebase.firestore.FieldValue.serverTimestamp() } }, { merge:true });
      });
    } catch(e){
      console.error('Start round failed', e);
      showToast('Start feilet – sjekk regler/API‑key/App Check');
    }
  }

  async function endSharedRound(){ try{ if(fb.roomRef){ await fb.roomRef.set({ round:{ status:'idle' } }, { merge:true }); } }catch(e){ console.error(e); } }

  // ——————————————————————————————————————————————
  // Local-only fallback (not used when Firebase works)
  // ——————————————————————————————————————————————
  function localStart(){
    result = { type: 'Kill', weapon: pick(WEAPONS) }; isKiller = true; const now = Date.now(); countdownStart = now; timerStartAt = now + COUNTDOWN_SECONDS*1000; state = State.Countdown;
  }

  // ——————————————————————————————————————————————
  // Input handling
  // ——————————————————————————————————————————————
  canvas.addEventListener('pointerdown', ()=>{ initAudio(); handlePrimary(); });
  window.addEventListener('keydown', e=>{
    if(e.key===' '||e.key==='Enter'){ initAudio(); handlePrimary(); }
    if(e.key.toLowerCase()==='t'){ tryRunSelfTests(); }
    if(e.key.toLowerCase()==='r'){ resetLocal(); }
    if(e.key.toLowerCase()==='d'){ diagnoseBackend(); }
  });

  async function handlePrimary(){
    if(state===State.Join){
      const name = (local.name || prompt('Ditt navn? (sing3 meng2)', local.name||'')) || 'Spiller';
      const code = (local.room || prompt('Romkode?', local.room||'MORD')) || 'MORD';
      await joinRoom(name, code);
      return;
    }
    if(state===State.Lobby){
      if(firebaseAvailable()) await startSharedRound(); else localStart();
      return;
    }
    if(state===State.Result){ state = State.RoundTimer; return; }
    if(state===State.RoundTimer){ await endSharedRound(); state = firebaseAvailable()? State.Lobby : State.Join; return; }
  }

  function resetLocal(){
    try{ localStorage.removeItem('mmm_name'); localStorage.removeItem('mmm_room'); }catch(e){}
    location.reload();
  }

  async function diagnoseBackend(){
    const ok = await fbInitIfNeeded(); if(!ok){ showToast('Firebase ikke init'); return; }
    const testRef = fb.db.collection('diagnostics').doc('ping');
    try{ await testRef.set({ t: Date.now(), ua: navigator.userAgent }); showToast('Backend OK'); }
    catch(e){ showToast('Backend skriver ikke'); console.error('Diagnostics write failed:', e); }
  }

  // ——————————————————————————————————————————————
  // Drawing helpers & screens
  // ——————————————————————————————————————————————
  function drawBG(t){
    const g = ctx.createLinearGradient(0,0,W,H); const s=0.5+0.5*Math.sin(t*0.0002);
    g.addColorStop(0,`hsl(${lerp(210,265,s)},70%,10%)`); g.addColorStop(1,`hsl(${lerp(185,220,s)},80%,16%)`);
    ctx.fillStyle=g; ctx.fillRect(0,0,W,H);
    const r=Math.hypot(W,H)*0.55; const vg=ctx.createRadialGradient(CX,CY,r*0.2,CX,CY,r); vg.addColorStop(0,'rgba(0,0,0,0)'); vg.addColorStop(1,'rgba(0,0,0,0.35)'); ctx.fillStyle=vg; ctx.fillRect(0,0,W,H);
  }
  function roundRect(x,y,w,h,r){ const rr=Math.min(r,w/2,h/2); ctx.beginPath(); ctx.moveTo(x+rr,y); ctx.arcTo(x+w,y,x+w,y+h,rr); ctx.arcTo(x+w,y+h,x,y+h,rr); ctx.arcTo(x,y+h,x,y,rr); ctx.arcTo(x,y,x+w,y,rr); ctx.closePath(); }

  function drawJoin(){
    ctx.save(); ctx.textAlign='center'; ctx.textBaseline='middle';
    ctx.font=`800 ${Math.round(Math.min(W,H)*0.08)}px/1 ui-sans-serif`; ctx.fillStyle='rgba(255,255,255,0.95)'; ctx.fillText('Moro med Mord', CX, CY-90);
    ctx.font=`500 ${Math.round(Math.min(W,H)*0.028)}px/1.4 ui-sans-serif`; ctx.fillStyle='rgba(255,255,255,0.8)';
    const online = firebaseAvailable();
    ctx.fillText(online?"Trykk for å bli med i et rom (fong4 gaan1)":"Firebase ikke konfigurert – lokal modus", CX, CY-20);
    ctx.fillText("'hoi1 ci2' = start", CX, CY+20);
    const b={w:Math.min(W*0.7,340),h:64}; b.x=CX-b.w/2; b.y=CY+80; b.r=18; roundRect(b.x,b.y,b.w,b.h,b.r); const grad=ctx.createLinearGradient(b.x,b.y,b.x+b.w,b.y+b.h); grad.addColorStop(0,'#7dd3fc'); grad.addColorStop(1,'#a78bfa'); ctx.fillStyle=grad; ctx.fill(); ctx.fillStyle='#0b0f19'; ctx.font='800 22px ui-sans-serif'; ctx.fillText('Trykk for å bli med', CX, b.y+b.h/2+2);
    ctx.restore();
  }

  function drawLobby(t){
    ctx.save(); ctx.textAlign='center'; ctx.textBaseline='middle';
    ctx.font=`800 ${Math.round(Math.min(W,H)*0.06)}px/1 ui-sans-serif`; ctx.fillStyle='rgba(255,255,255,0.95)'; ctx.fillText('Lobby', CX, CY-180);
    ctx.font=`600 ${Math.round(Math.min(W,H)*0.028)}px/1.4 ui-sans-serif`; ctx.fillStyle='rgba(255,255,255,0.85)';
    const online = firebaseAvailable();
    ctx.fillText(online?`Rom: ${local.room}`:`Lokal modus`, CX, CY-130);
    ctx.fillText(`Navn: ${local.name||'Spiller'}`, CX, CY-100);

    // Active players
    let activeCount = 1; let namesList = [local.name||'Spiller'];
    if(online){ const now = Date.now(); const actives = players.filter(p=> p.lastSeen && (now - p.lastSeen.toMillis()) < 20000); activeCount = actives.length; namesList = actives.map(p=> p.name || p.id); }
    ctx.fillText(`Aktive spillere: ${activeCount}`, CX, CY-40);
    ctx.font=`500 ${Math.round(Math.min(W,H)*0.024)}px/1.6 ui-sans-serif`; ctx.fillStyle='rgba(255,255,255,0.75)'; ctx.fillText(namesList.join('  ·  '), CX, CY);

    // Backend status
    ctx.font=`500 ${Math.round(Math.min(W,H)*0.02)}px/1.2 ui-sans-serif`; ctx.fillStyle='rgba(255,255,255,0.65)';
    const backend = fb.backendReady? `Backend: ✓ ${FIREBASE_CONFIG.projectId}` : 'Backend: ✗';
    ctx.fillText(backend + "  —  R = reset, D = diagnose", CX, CY+40);

    // Start button
    const b={w:Math.min(W*0.7,360),h:68}; b.x=CX-b.w/2; b.y=CY+100; b.r=22; roundRect(b.x,b.y,b.w,b.h,b.r); const grad=ctx.createLinearGradient(b.x,b.y,b.x+b.w,b.y+b.h); grad.addColorStop(0,'#4ade80'); grad.addColorStop(1,'#22d3ee'); ctx.fillStyle=grad; ctx.fill(); ctx.fillStyle='#0b0f19'; ctx.font='900 22px ui-sans-serif'; ctx.fillText('Start runde', CX, b.y+b.h/2+2);
    ctx.font=`500 ${Math.round(Math.min(W,H)*0.02)}px/1.4 ui-sans-serif`; ctx.fillStyle='rgba(255,255,255,0.65)'; ctx.fillText("Trykk for å starte – lyd: trykk en gang ('sing1 jam1')", CX, b.y+b.h+28);
    ctx.restore();
  }

  function drawCountdown(now){
    const elapsed = Math.max(0, (now - countdownStart)/1000); const total=COUNTDOWN_SECONDS; const remaining=clamp(total - elapsed, 0, total); const progress = clamp(elapsed/total,0,1);
    const displayNum = Math.ceil(remaining); const seg = elapsed - Math.floor(elapsed); const scale = 1.4 - 0.4*easeOutCubic(seg);
    const r = Math.min(W,H)*0.22; ctx.save(); ctx.translate(CX,CY);
    ctx.beginPath(); ctx.arc(0,0,r,0,Math.PI*2); ctx.strokeStyle='rgba(255,255,255,0.12)'; ctx.lineWidth=Math.max(10,r*0.08); ctx.stroke();
    ctx.beginPath(); ctx.arc(0,0,r,-Math.PI/2,-Math.PI/2+progress*Math.PI*2); ctx.strokeStyle='rgba(255,255,255,0.9)'; ctx.lineCap='round'; ctx.lineWidth=Math.max(10,r*0.08); ctx.stroke();
    ctx.fillStyle='rgba(255,255,255,0.9)'; ctx.textAlign='center'; ctx.textBaseline='middle'; ctx.font=`900 ${Math.round(Math.min(W,H)*0.22*scale)}px/1 ui-sans-serif`; ctx.fillText(String(displayNum),0,8);
    ctx.font=`600 ${Math.round(Math.min(W,H)*0.03)}px/1 ui-sans-serif`; ctx.fillStyle='rgba(255,255,255,0.7)'; ctx.fillText('Nedtelling', 0, -r - Math.min(W,H)*0.06); ctx.restore();
    if(remaining<=0) state = State.Result;
  }

  function drawResult(){
    const title = result?.type==='Kill' ? 'KILL' : 'FLEE';
    ctx.save(); ctx.textAlign='center'; ctx.textBaseline='middle';
    ctx.font=`900 ${Math.round(Math.min(W,H)*0.16)}px/1 ui-sans-serif`; ctx.fillStyle = result?.type==='Kill' ? 'rgba(255,110,110,0.95)' : 'rgba(150,240,255,0.95)'; ctx.fillText(title, CX, CY - Math.min(W,H)*0.06);
    ctx.font=`700 ${Math.round(Math.min(W,H)*0.05)}px/1 ui-sans-serif`; ctx.fillStyle='rgba(255,255,255,0.9)'; ctx.fillText(result?.type==='Kill' ? 'Hemmelige roller' : 'Kom dere unna!', CX, CY + Math.min(W,H)*0.03);
    if(result?.type==='Kill' && result?.weapon){ ctx.font=`700 ${Math.round(Math.min(W,H)*0.04)}px/1 ui-sans-serif`; ctx.fillStyle='rgba(255,230,230,0.95)'; ctx.fillText('Våpen: '+result.weapon, CX, CY + Math.min(W,H)*0.10); }
    ctx.font=`500 ${Math.round(Math.min(W,H)*0.022)}px/1 ui-sans-serif`; ctx.fillStyle='rgba(255,255,255,0.8)'; ctx.fillText("'si4 gaan3' (tid) begynner straks", CX, CY + Math.min(W,H)*0.18);
    ctx.restore();
  }

  function drawRoundTimer(now){
    const start = timerStartAt || Date.now(); const elapsed=(now-start)/1000; const remaining=clamp(ROUND_SECONDS-elapsed,0,ROUND_SECONDS); const progress=1-remaining/ROUND_SECONDS;
    ctx.save(); ctx.textAlign='center'; ctx.textBaseline='middle';
    const r=Math.min(W,H)*0.25; ctx.translate(CX,CY);
    ctx.beginPath(); ctx.arc(0,0,r,0,Math.PI*2); ctx.strokeStyle='rgba(255,255,255,0.12)'; ctx.lineWidth=Math.max(10,r*0.08); ctx.stroke();
    ctx.beginPath(); ctx.arc(0,0,r,-Math.PI/2,-Math.PI/2+progress*Math.PI*2); ctx.strokeStyle='rgba(255,255,255,0.9)'; ctx.lineCap='round'; ctx.lineWidth=Math.max(10,r*0.08); ctx.stroke();
    const mm=Math.floor(remaining/60), ss=Math.floor(remaining%60); const timeStr=`${String(mm).padStart(2,'0')}:${String(ss).padStart(2,'0')}`;
    ctx.fillStyle='rgba(255,255,255,0.95)'; ctx.font=`900 ${Math.round(Math.min(W,H)*0.14)}px/1 ui-sans-serif`; ctx.fillText(timeStr,0,6);
    ctx.font=`800 ${Math.round(Math.min(W,H)*0.05)}px/1 ui-sans-serif`; ctx.fillStyle='rgba(255,255,255,0.92)'; ctx.fillText('KILLER‑TIMER', 0, -r - Math.min(W,H)*0.06);
    ctx.font=`600 ${Math.round(Math.min(W,H)*0.028)}px/1.2 ui-sans-serif`; ctx.fillStyle='rgba(255,255,255,0.85)'; ctx.fillText(isKiller?`Du er morderen`:`Skjul dere! ('zau2' = løp)`, 0, r + Math.min(W,H)*0.06);
    if(isKiller && result?.weapon){ ctx.font=`700 ${Math.round(Math.min(W,H)*0.032)}px/1 ui-sans-serif`; ctx.fillStyle='rgba(255,230,230,0.95)'; ctx.fillText('Våpen: '+result.weapon, 0, r + Math.min(W,H)*0.12); }
    ctx.font=`500 ${Math.round(Math.min(W,H)*0.02)}px/1 ui-sans-serif`; ctx.fillStyle='rgba(255,255,255,0.65)'; ctx.fillText("Trykk for ny runde når tiden er over — 'zoi3 loi4' = igjen", 0, r + Math.min(W,H)*0.18);
    ctx.restore();

    if(remaining<=0){ if(isKiller){ playBeep(); } endSharedRound(); state = firebaseAvailable()? State.Lobby : State.Join; }
  }

  // ——————————————————————————————————————————————
  // Minimal self-tests (press 'T' or add ?test=1)
  // ——————————————————————————————————————————————
  function tryRunSelfTests(){
    const results=[]; const assert=(n,c)=>results.push({name:n,pass:!!c});
    try{
      assert('Canvas context', !!ctx);
      assert('20 weapons', WEAPONS.length===20);
      // Local fallback flow
      const prev = USE_FIREBASE; USE_FIREBASE=false; localStart(); assert('Entered countdown', state===State.Countdown); state=State.Result; TEST_MODE=true; timerStartAt=Date.now()-ROUND_SECONDS*1000-100; drawRoundTimer(performance.now()); assert('Timer end triggers', true); TEST_MODE=false; USE_FIREBASE=prev;
    }catch(e){ results.push({name:'Exception',pass:false,error:String(e)}); }
    console.group('Self-tests'); for(const r of results){ console[r.pass?'log':'error'](`${r.pass?'PASS':'FAIL'}: ${r.name}`); if(r.error) console.error(r.error); } console.groupEnd(); showToast(results.every(r=>r.pass)?'TESTS PASS':'TESTS FAIL');
  }

  function showToast(text){
    const t0 = performance.now(); function tick(){ const t=(performance.now()-t0)/1000; if(t>2.2) return; ctx.save(); ctx.textAlign='center'; ctx.textBaseline='middle'; ctx.font=`700 ${Math.round(Math.min(W,H)*0.03)}px/1 ui-sans-serif`; ctx.fillStyle='rgba(0,0,0,0.45)'; ctx.fillRect(CX-260, H*0.12-24, 520, 48); ctx.fillStyle='#fff'; ctx.fillText(text, CX, H*0.12); ctx.restore(); requestAnimationFrame(tick);} requestAnimationFrame(tick);
  }

  // ——————————————————————————————————————————————
  // Main loop
  // ——————————————————————————————————————————————
  function loop(t){
    drawBG(t);
    if(qp.get('test')==='1'){ tryRunSelfTests(); history.replaceState({},'',location.pathname); }
    if(state===State.Join) drawJoin();
    else if(state===State.Lobby) drawLobby(t);
    else if(state===State.Countdown) drawCountdown(t);
    else if(state===State.Result){ drawResult(); state = State.RoundTimer; }
    else if(state===State.RoundTimer) drawRoundTimer(t);
    requestAnimationFrame(loop);
  }
  requestAnimationFrame(loop);
})();
});
</script>
</body>
</html>